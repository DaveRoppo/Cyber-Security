# About
A Malware traffic analysis exercise from a pcap posted on Malware-Traffic-Analysis.net on 2023-05-26 by Brad Duncan featuring IcedID malware.

Link to Brad Duncan's exercise archives: https://www.malware-traffic-analysis.net/
## What is IcedID?
IcedID is a sophisticated banking trojan that goes beyond traditional banking threats by incorporating features commonly found in information stealers and modular malware.

By performing web injection on browsers and acting as proxy to manipulate traffic, it steals sensitive financial information, login credentials, and other personal data from infected systems. It then sends that stolen information to a remote server.

IcedID is often distributed through phishing campaigns, malicious email attachments, exploit kits, or other social engineering techniques. Once a system is infected, IcedID establishes a foothold and begins its malicious activities.

Since 2017, IcedID has demonstrated a high degree of adaptability and evolution. It has been observed incorporating new features, updating its infection techniques, and adjusting its tactics to evade detection by security solutions. It is even sometimes used as a delivery mechanism for other malware, making it a part of larger and more complex cybercrime operations by threat groups such as TA551.

Given its adaptability and ongoing development, IcedID remains a concern for cybersecurity professionals, and its detection and mitigation require a combination of advanced threat intelligence, endpoint protection, and network security measures. Organizations should stay informed about the latest threats and adopt best practices to defend against evolving banking trojans like IcedID.

## MITRE ATT&CK IcedID & TA551 Threat Group References
![](img/IcedID.png)
![](img/group.png)

For a deeper dive into TA551's use of IcedID, see [TA551: Email Attack Campaign Switches from Valak to IcedID](https://unit42.paloaltonetworks.com/ta551-shathak-icedid/)

## PCAP LAN Details 
- **LAN segment range**: 10.4.19[.]0/24 (10.4.19[.]1 through 10.4.19[.]255)
- **Domain**: boogienights[.]live
- **Active Directory Domain controller IP address**: 10.4.19[.]19
- **Active Directory Domain controller hostname**: WIN-GP4JHCK2JMV
- **LAN segment gateway**: 10.4.19[.]1
- **LAN segment broadcast address**: 10.4.19[.]255

## Exercise Questions
#### What is the date and time in UTC the infection started?
###### Before diving in with Wireshark, let's run the pcap through zeek to quickly identify any traffic anomalies that will help us identify the infected host:
![](img/zeek.png)
![](img/zeek2.png)
![](img/zeek3.png)
![](img/zvt.png)
*Viewing endpoint statistics to look for any asymmetric outbound traffic volume from internal hosts:*
![](img/endpoints.png)

*Demonstrating the default values for certificate generation (Because many C2 domains use self-signed certificates)*
![](img/self.png)

*Because many C2 domains use self-signed certificates, I filtered for packets containing "Internet Widgets Pty Ltd" (courtesy of Unit 42)*
![](img/selfproof.png)

*Potential C2 botnet domain submitted to VirusTotal reveals it's relation to IcedID*
![](img/skan.png)

*The initial contact (unencrypted HTTP GET request typically generated by IcedID installers, possibly delivered by phishing with word docs containing malicious embedded macros)*
![](img/contact2.png)

#### MITRE ATT&CK Technique Reference & Mitigation Measures
![](img/T1566.001.png)
#### Mitgations: AV/AM, NIPS, Block unknown attachments, Email Authentication Mechanisms, User Training 
![](img/T1204.002.png)
#### Mitgations: User Traininig, Execution Prevention, Behavior Prevention on Endpoint
<hr>

*Following the TCP stream reveals a redirect to the firebasestorage url*

![](img/stream.png)

![](img/goog2.png)

*275kb of conversation data reveals the potential for a file being sent to the infected host*
![](img/goog3.png)

*URLhaus reveals the zip archive that was previously hosted at this url*
![](img/haus.png)

*firebasestorage url submitted to VirusTotal reveals malicious activity related to IcedID*
![](img/goog.png)

*Following stream 53 reveals cookie parameters unique to IcedID infections that identify the infected hostname and account name in hex values (See _u=) as well as the gzip binary typically used for persistence in IcedID infections*
![](img/get.png)

#### MITRE ATT&CK Technique Reference & Mitigations
![](img/T1027.png)
#### Mitigations: AV/AM, Behavior Prevention on Endpoint, Regular Audits, User Training
<hr>

*Following retrieval of the gzip binary, HTTPS traffic to multiple C2 botnet domains begins*
![](img/beacon1.png)

*Domain submission to VirusTotal confirms association with IcedID C2*
![](img/skig.png)

![](img/spaker.png)

![](img/hopsc2.png)

#### MITRE ATT&CK Technique Reference & Mitigation
![](img/T1071.001.png)
#### Mitigation: Network Intrusion Prevention System
![](img/t1573.png)
#### Mitigations: Network Intrusion Prevention System, SSL/TLS Inspection
<hr>

#### What is the IP address, MAC address, hostname, and account name of the infected Windows client?

![](img/csilva2.png)

![](img/host+mac.png)

#### Is there any follow-up activity from other malware?
*Display filter for identifying BackConnect traffic (typical follow-up activity for IcedID infections*
![](img/back3.png)

To read more about BackConnect traffic as it relates to IcedID infections, see [IcedID BackConnect Protocol](https://www.netresec.com/?page=Blog&month=2022-10&post=IcedID-BackConnect-Protocol)
<hr>

*Following TCP stream 951 reveals enumeration of additional hosts on the doamin*
![](img/back.png)

#### MITRE ATT&CK Technique Reference & Mitigations
![](img/T1082.png)
#### Mitigations: *This type of attack technique cannot be easily mitigated with preventive controls since it is based on the abuse of system features.*
![](img/T1087.002.png)
#### MItigation: Proper Operating System Configuraiton: Disable Enumeration of Admin Accounts on Elevation
<hr>

*Following TCP stream 953 reveals enumeration of the victim's disk drive lists and it's contents*
![](img/back2.png)

## Acknowledgements
To read more about this exercise, see [Cold as Ice: Unit 42 Wireshark Quiz for IcedID]([https://unit42.paloaltonetworks.com/ta551-shathak-icedid/](https://unit42.paloaltonetworks.com/wireshark-quiz-icedid/)https://unit42.paloaltonetworks.com/wireshark-quiz-icedid/)
